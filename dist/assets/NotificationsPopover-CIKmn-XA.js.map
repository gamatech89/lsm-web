{"version":3,"file":"NotificationsPopover-CIKmn-XA.js","sources":["../../src/components/common/NotificationsPopover.tsx"],"sourcesContent":["import { useState } from 'react';\nimport { Button, Badge, Popover, List, Typography, Empty, Spin } from 'antd';\nimport { BellOutlined, CheckCircleOutlined, InfoCircleOutlined, WarningOutlined } from '@ant-design/icons';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { api } from '@/lib/api';\nimport { formatRelativeTime } from '@lsm/utils';\nimport { useNavigate } from 'react-router-dom';\nimport { useThemeStore } from '@/stores/theme';\n\nconst { Text } = Typography;\n\nexport function NotificationsPopover() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [open, setOpen] = useState(false);\n  const { resolvedTheme } = useThemeStore();\n  const isDark = resolvedTheme === 'dark';\n\n  // Fetch unread count\n  const { data: unreadData } = useQuery({\n    queryKey: ['notifications', 'unread-count'],\n    queryFn: () => api.notifications.getUnreadCount().then(r => r.data),\n    refetchInterval: 30000,\n  });\n\n  // Fetch notifications list\n  const { data: notificationsData, isLoading } = useQuery({\n    queryKey: ['notifications', 'list'],\n    queryFn: () => api.notifications.list().then(r => r.data),\n    enabled: open, // Only fetch when open\n  });\n\n  // Mark as read mutation\n  const markReadMutation = useMutation({\n    mutationFn: (id: string) => api.notifications.markAsRead(id),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['notifications'] });\n    },\n  });\n\n  // Mark all as read mutation\n  const markAllReadMutation = useMutation({\n    mutationFn: () => api.notifications.markAllAsRead(),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['notifications'] });\n    },\n  });\n\n  const handleNotificationClick = (notification: any) => {\n    // Mark as read if not already\n    if (!notification.read_at) {\n      markReadMutation.mutate(notification.id);\n    }\n\n    // Navigate based on type/data\n    const { type, data } = notification;\n\n    if (data.project_id) {\n       if (type.includes('Todo')) {\n          navigate(`/projects/${data.project_id}`);\n       } else {\n          navigate(`/projects/${data.project_id}`);\n       }\n    } else if (data.url) {\n        navigate(data.url);\n    }\n    \n    setOpen(false);\n  };\n\n  const notifications = notificationsData?.data?.data || [];\n  const unreadCount = unreadData?.data?.count || 0;\n\n  const content = (\n    <div style={{ width: 350, maxHeight: 400, display: 'flex', flexDirection: 'column' }}>\n      <div style={{ \n        padding: '12px 16px', \n        borderBottom: isDark ? '1px solid #334155' : '1px solid #f0f0f0',\n        display: 'flex',\n        justifyContent: 'space-between',\n        alignItems: 'center'\n      }}>\n        <Text strong>Notifications</Text>\n        {unreadCount > 0 && (\n          <Button \n            type=\"link\" \n            size=\"small\" \n            onClick={() => markAllReadMutation.mutate()}\n            loading={markAllReadMutation.isPending}\n            style={{ padding: 0 }}\n          >\n            Mark all read\n          </Button>\n        )}\n      </div>\n\n      <div style={{ overflowY: 'auto', flex: 1 }}>\n        {isLoading ? (\n          <div style={{ padding: 24, textAlign: 'center' }}>\n            <Spin size=\"small\" />\n          </div>\n        ) : notifications.length === 0 ? (\n          <Empty \n            image={Empty.PRESENTED_IMAGE_SIMPLE} \n            description=\"No notifications\" \n            style={{ margin: '24px 0' }}\n          />\n        ) : (\n          <List\n            dataSource={notifications}\n            renderItem={(item: any) => (\n              <div \n                onClick={() => handleNotificationClick(item)}\n                style={{ \n                  padding: '12px 16px',\n                  cursor: 'pointer',\n                  background: !item.read_at \n                    ? (isDark ? 'rgba(99, 102, 241, 0.1)' : '#f0f9ff') \n                    : 'transparent',\n                  borderBottom: isDark ? '1px solid #334155' : '1px solid #f0f0f0',\n                  transition: 'background 0.2s',\n                  display: 'flex',\n                  gap: 12\n                }}\n                className=\"notification-item\"\n              >\n                  {/* Icon based on type */}\n                  <div style={{ marginTop: 2 }}>\n                     {item.type.includes('Success') || item.type.includes('Completed') ? (\n                         <CheckCircleOutlined style={{ color: '#22c55e', fontSize: 16 }} />\n                     ) : item.type.includes('Warning') || item.type.includes('Alert') ? (\n                         <WarningOutlined style={{ color: '#f59e0b', fontSize: 16 }} />\n                     ) : (\n                         <InfoCircleOutlined style={{ color: '#6366f1', fontSize: 16 }} />\n                     )}\n                  </div>\n                  \n                  <div style={{ flex: 1 }}>\n                    <div style={{ marginBottom: 4 }}>\n                       <Text style={{ fontSize: 13 }}>\n                          {item.data.message || 'New notification'}\n                       </Text>\n                    </div>\n                    <Text type=\"secondary\" style={{ fontSize: 11 }}>\n                      {formatRelativeTime(item.created_at)}\n                    </Text>\n                  </div>\n                  \n                  {!item.read_at && (\n                    <div style={{ display: 'flex', alignItems: 'center' }}>\n                       <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#6366f1' }} />\n                    </div>\n                  )}\n              </div>\n            )}\n          />\n        )}\n      </div>\n      \n      <style>{`\n          .notification-item:hover {\n              background: ${isDark ? 'rgba(255,255,255,0.05)' : '#fafafa'} !important;\n          }\n      `}</style>\n    </div>\n  );\n\n  return (\n    <Popover\n      content={content}\n      trigger=\"click\"\n      open={open}\n      onOpenChange={setOpen}\n      placement=\"bottomRight\"\n      overlayInnerStyle={{ padding: 0 }}\n    >\n      <Badge count={unreadCount} size=\"small\" offset={[-4, 4]}>\n        <Button\n          type=\"text\"\n          icon={<BellOutlined />}\n          style={{\n            width: 40,\n            height: 40,\n            color: open ? '#6366f1' : undefined,\n            borderRadius: 10,\n          }}\n        />\n      </Badge>\n    </Popover>\n  );\n}\n"],"names":["Text","Typography","NotificationsPopover","navigate","useNavigate","queryClient","useQueryClient","open","setOpen","useState","resolvedTheme","useThemeStore","isDark","unreadData","useQuery","api","r","notificationsData","isLoading","markReadMutation","useMutation","id","markAllReadMutation","handleNotificationClick","notification","type","data","notifications","_a","unreadCount","_b","content","jsxs","jsx","Button","Spin","Empty","List","item","CheckCircleOutlined","WarningOutlined","InfoCircleOutlined","formatRelativeTime","Popover","Badge","BellOutlined"],"mappings":"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"}